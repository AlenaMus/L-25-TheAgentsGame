<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Even/Odd Tournament - Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status.connected {
            background: #4CAF50;
            color: white;
        }

        .status.disconnected {
            background: #f44336;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #667eea;
        }

        .standings-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .standings-table tr:hover {
            background: #f8f9fa;
        }

        .rank-1 {
            background: #fff9e6 !important;
            font-weight: bold;
        }

        .trophy {
            color: #ffd700;
            margin-left: 5px;
        }

        .match-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .match-live {
            border-left-color: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .match-players {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .match-result {
            color: #666;
            font-size: 0.9em;
        }

        .winner {
            color: #4CAF50;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        #eventLog {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-entry.match_completed {
            background: #e8f5e9;
        }

        .log-entry.round_completed {
            background: #fff3e0;
            font-weight: bold;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #764ba2;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è Even/Odd Tournament - Live Dashboard</h1>
            <p>Real-time tournament visualization</p>
            <div id="connectionStatus" class="status disconnected">Disconnected</div>
        </header>

        <div class="grid">
            <div>
                <div class="card">
                    <h2>üèÜ Live Standings</h2>
                    <button class="refresh-btn" onclick="loadStandings()">Refresh Standings</button>
                    <table class="standings-table" id="standingsTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Points</th>
                                <th>W-L-T</th>
                                <th>Win %</th>
                            </tr>
                        </thead>
                        <tbody id="standingsBody">
                            <tr><td colspan="5" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>üéÆ Recent Matches</h2>
                    <button class="refresh-btn" onclick="loadMatches()">Refresh Matches</button>
                    <div id="matchesList" style="margin-top: 15px;">
                        <p style="color:#999;text-align:center;">Loading...</p>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>üìä Tournament Stats</h2>
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-box">
                            <div class="stat-value" id="currentRound">-</div>
                            <div class="stat-label">Current Round</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalMatches">-</div>
                            <div class="stat-label">Total Matches</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalPlayers">-</div>
                            <div class="stat-label">Players</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="tournamentStatus">-</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>üìù Live Event Log</h2>
                    <div id="eventLog"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Updated to use port 9000 (Game Orchestrator)
        const API_BASE = 'http://localhost:9000';
        const WS_URL = 'ws://localhost:9000/ws';
        let ws = null;
        let reconnectInterval = null;

        // Initialize
        window.onload = function() {
            connectWebSocket();
            loadTournamentInfo();
            loadStandings();
            loadMatches();

            // Refresh data every 10 seconds
            setInterval(() => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    loadStandings();
                    loadMatches();
                }
            }, 10000);
        };

        // WebSocket connection
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('connectionStatus').textContent = 'Connected (Live)';
                document.getElementById('connectionStatus').className = 'status connected';
                addLogEntry('System', 'Connected to live tournament feed');

                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('connectionStatus').textContent = 'Disconnected (Polling)';
                document.getElementById('connectionStatus').className = 'status disconnected';
                addLogEntry('System', 'Disconnected from live feed');

                // Reconnect after 5 seconds
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            console.log('WebSocket event:', data);

            // Handle different message formats
            if (data.type === 'tournament') {
                updateTournamentStats(data.data);
            } else if (data.type === 'standings') {
                updateStandings(data.data);
            } else if (data.type === 'health') {
                // Agent health updates
                console.log('Health update:', data.data);
            } else if (data.event) {
                // Handle legacy event format
                handleLegacyEvent(data);
            }
        }

        // Handle legacy event format
        function handleLegacyEvent(data) {
            switch(data.event) {
                case 'match_started':
                    addLogEntry('Match Started', `${data.player1} vs ${data.player2}`);
                    loadMatches();
                    break;

                case 'match_completed':
                    addLogEntry('Match Complete', `Winner: ${data.winner || 'Tie'}`);
                    loadStandings();
                    loadMatches();
                    break;

                case 'standings_updated':
                    addLogEntry('Standings', 'Updated');
                    loadStandings();
                    break;

                case 'round_started':
                    addLogEntry('Round Started', `Round ${data.round_number}`);
                    loadTournamentInfo();
                    break;

                case 'round_completed':
                    addLogEntry('Round Complete', `Round ${data.round_number} finished`);
                    loadTournamentInfo();
                    loadStandings();
                    break;

                case 'tournament_completed':
                    addLogEntry('Tournament', 'üèÜ TOURNAMENT COMPLETE!');
                    loadStandings();
                    break;
            }
        }

        // Update tournament stats from WebSocket
        function updateTournamentStats(data) {
            if (data.current_round !== undefined) {
                document.getElementById('currentRound').textContent = data.current_round || '-';
            }
            if (data.stage) {
                document.getElementById('tournamentStatus').textContent = data.stage;
            }
        }

        // Update standings from WebSocket
        function updateStandings(standings) {
            if (!Array.isArray(standings)) return;

            const tbody = document.getElementById('standingsBody');
            tbody.innerHTML = standings.map((player, index) => `
                <tr class="${index === 0 ? 'rank-1' : ''}">
                    <td>${index + 1}${index === 0 ? '<span class="trophy">üèÜ</span>' : ''}</td>
                    <td>${player.display_name || player.player_id}</td>
                    <td><strong>${player.points}</strong></td>
                    <td>${player.wins}-${player.losses}-${player.ties || player.draws || 0}</td>
                    <td>${player.win_rate ? (player.win_rate * 100).toFixed(1) + '%' : '0%'}</td>
                </tr>
            `).join('');
        }

        // Load tournament info
        async function loadTournamentInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/tournament`);
                const data = await response.json();

                document.getElementById('currentRound').textContent = data.current_round || '-';
                document.getElementById('totalPlayers').textContent = data.total_players || '-';
                document.getElementById('tournamentStatus').textContent = data.status || 'N/A';
            } catch (error) {
                console.error('Error loading tournament info:', error);
            }
        }

        // Load standings
        async function loadStandings() {
            try {
                const response = await fetch(`${API_BASE}/api/standings`);
                const standings = await response.json();

                const tbody = document.getElementById('standingsBody');
                tbody.innerHTML = standings.map((player, index) => `
                    <tr class="${index === 0 ? 'rank-1' : ''}">
                        <td>${index + 1}${index === 0 ? '<span class="trophy">üèÜ</span>' : ''}</td>
                        <td>${player.display_name || player.player_id}</td>
                        <td><strong>${player.points}</strong></td>
                        <td>${player.wins}-${player.losses}-${player.ties}</td>
                        <td>${player.win_rate ? (player.win_rate * 100).toFixed(1) + '%' : '0%'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading standings:', error);
                document.getElementById('standingsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#f44336;">Error loading standings</td></tr>';
            }
        }

        // Load matches
        async function loadMatches() {
            try {
                const response = await fetch(`${API_BASE}/api/matches?limit=10`);
                const matches = await response.json();

                document.getElementById('totalMatches').textContent = matches.length;

                const matchesList = document.getElementById('matchesList');
                matchesList.innerHTML = matches.map(match => `
                    <div class="match-item ${match.status === 'in_progress' ? 'match-live' : ''}">
                        <div class="match-players">
                            ${match.player1_id} vs ${match.player2_id}
                        </div>
                        <div class="match-result">
                            ${match.winner_id ?
                                `<span class="winner">Winner: ${match.winner_id}</span> ‚Ä¢ Draw: ${match.drawn_number}` :
                                match.status === 'in_progress' ? 'In Progress...' : 'Pending'
                            }
                        </div>
                    </div>
                `).join('') || '<p style="color:#999;text-align:center;">No matches yet</p>';
            } catch (error) {
                console.error('Error loading matches:', error);
                document.getElementById('matchesList').innerHTML = '<p style="color:#f44336;text-align:center;">Error loading matches</p>';
            }
        }

        // Add log entry
        function addLogEntry(type, message) {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type.toLowerCase().replace(' ', '_')}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${type}: ${message}`;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }
    </script>
</body>
</html>
